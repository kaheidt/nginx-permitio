server {
    listen 80;
    server_name localhost;

    # Enable NGINX JavaScript module
    js_import main from /etc/nginx/conf.d/permit.js;
    js_set $permitio_token main.permitio_token;

    # Logging configuration
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log debug;

    # API endpoints
    location /api/v1/vehicles {
        auth_request /_permit_check_auth;
        auth_request_set $authorization $upstream_http_authorization;
        proxy_set_header Authorization $authorization;
        proxy_pass ${VEHICLE_TELEMETRY_SERVICE_URL};
    }

    location /api/v1/maintenance {
        auth_request /_permit_check_auth;
        auth_request_set $authorization $upstream_http_authorization;
        proxy_set_header Authorization $authorization;
        proxy_pass ${MAINTENANCE_SERVICE_URL};
    }

    location /api/v1/fleet {
        auth_request /_permit_check_auth;
        auth_request_set $authorization $upstream_http_authorization;
        proxy_set_header Authorization $authorization;
        proxy_pass ${FLEET_MANAGEMENT_SERVICE_URL};
    }

    location /api/v1/analytics {
        auth_request /_permit_check_auth;
        auth_request_set $authorization $upstream_http_authorization;
        proxy_set_header Authorization $authorization;
        proxy_pass ${DRIVER_ANALYTICS_SERVICE_URL};
    }

    # Authentication service
    location /auth {
        proxy_pass ${AUTH_SERVICE_URL}/auth;
    }

    # Permit.io authorization check endpoint
    location = /_permit_check_auth {
        internal;
        js_content main.permitio_check_auth;
    }

    # Static content for demo frontend
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }
}