server {
    listen 80;
    server_name localhost;

    # Define variables from environment variables
    set $vehicle_telemetry_service_url "http://vehicle-telemetry:3001";
    set $maintenance_service_url "http://maintenance-service:3002";
    set $fleet_management_service_url "http://fleet-management:3003";
    set $driver_analytics_service_url "http://driver-analytics:3004";
    set $auth_service_url "http://auth-service:3000";
    
    # Add DNS resolver for Docker's internal DNS
    resolver 127.0.0.11 ipv6=off;

    # Enable NGINX JavaScript module
    js_import main from /etc/nginx/conf.d/permit.js;
    js_set $permitio_token main.permitio_token;

    # Logging configuration
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log debug;

    # Common proxy settings - applied to all locations
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # API endpoints
    location /api/v1/vehicles {
        auth_request /_permit_check_auth;
        # Preserve original client Authorization header
        proxy_set_header Authorization $http_authorization;
        proxy_pass $vehicle_telemetry_service_url;
    }

    location /api/v1/maintenance {
        auth_request /_permit_check_auth;
        # Preserve original client Authorization header
        proxy_set_header Authorization $http_authorization;
        proxy_pass $maintenance_service_url;
    }

    location /api/v1/fleet {
        auth_request /_permit_check_auth;
        # Preserve original client Authorization header
        proxy_set_header Authorization $http_authorization;
        proxy_pass $fleet_management_service_url;
    }

    location /api/v1/analytics {
        auth_request /_permit_check_auth;
        # Preserve original client Authorization header
        proxy_set_header Authorization $http_authorization;
        proxy_pass $driver_analytics_service_url;
    }

    # Authentication service
    location /auth/ {
        proxy_pass $auth_service_url$request_uri;
    }

    # Permit.io authorization check endpoint
    location = /_permit_check_auth {
        internal;
        js_content main.permitio_check_auth;
    }

    # Internal authorization check handler
    location = /_auth_check_internal {
        internal;
        js_content main.internal_auth_check;
    }

    # Static content for demo frontend
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }
}